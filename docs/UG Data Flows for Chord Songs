# Ultimate Guitar Data Flows for Chord Songs
## Comprehensive Documentation of Processing Pipelines

**Document Version:** 1.0  
**Date:** September 1, 2025  
**Scope:** Chord-type song processing from Ultimate Guitar  

---

## üéØ Overview

This document details two distinct data flows for processing Ultimate Guitar chord songs:

1. **HTML Tab ID Flow** - Processes songs from URLs with tab IDs
2. **Parent Script DB Query Flow** - Processes songs already stored in database with tab IDs

Both flows eventually merge to use the same core processing modules for data transformation, scoring, and storage.

---

## üìä Data Flow 1: HTML Tab ID Processing

### **Entry Point:** `url_tab_id_processor.js`

#### **Step 1: URL Input & Tab ID Extraction**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `shared/urlParser.js`

**Process:**
1. Receives Ultimate Guitar URL (e.g., `https://tabs.ultimate-guitar.com/tab/elvis-presley/cant-help-falling-in-love-chords-1086983`)
2. Calls `extractTabIdAndTypeFromUrl()` from `shared/urlParser.js`
3. Extracts tab ID (1086983) and song type ("chords")
4. Validates URL format and tab ID

**Output:** `{ tabId: 1086983, songType: "chords" }`

#### **Step 2: Database Lookup**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `songDatabaseUG.js`

**Process:**
1. Calls `getSongByUGTabId(tabId)` from `songDatabaseUG.js`
2. Checks if song already exists in database
3. If exists: proceeds to update flow
4. If not exists: proceeds to create flow

**Output:** Existing song record or null

#### **Step 3A: Basic Song Record Creation (New Songs)**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `songDatabaseUG.js`

**Process:**
1. Calls `createBasicSongRecord()` from `songDatabaseUG.js`
2. Creates minimal song record with:
   - `title`: "Cant Help Falling In Love Chords"
   - `artist`: "Elvis Presley"
   - `ug_tab_id`: 1086983
   - `ug_url`: "https://tabs.ultimate-guitar.com/tab/1086983"
   - `instrument_type`: "guitar"
   - `tuning`: "E A D G B E"
   - `tabbed_by`: "Unknown"
3. Stores in `songs` table
4. Returns song ID for next steps

**Output:** `{ success: true, songId: "uuid" }`

#### **Step 4: Ultimate Guitar Data Fetching**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `ugScraperIntegration.js`

**Process:**
1. Calls `fetchSongDataUG(tabId)` from `ugScraperIntegration.js`
2. Executes Go scraper binary: `ultimate-guitar-scraper export -id 1086983`
3. Receives HTML output from Ultimate Guitar
4. Parses HTML structure for song data
5. Extracts sections, chord progressions, and metadata

**Output:** Raw UG data structure

#### **Step 5: Data Transformation**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `songDataServiceUG.js`

**Process:**
1. Calls `transformUGDataToSongFormat()` from `songDataServiceUG.js`
2. Transforms raw HTML into structured song object:
   - Extracts song sections (Intro, Verse, Chorus, etc.)
   - Extracts chord progressions with timing
   - Extracts chord definitions with fingerings
   - Extracts metadata (album, year, genre, etc.)
3. Creates standardized song data structure

**Output:** Structured song data object

#### **Step 6: Data Completeness Scoring**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `shared/dataCompletenessScorer.js`, `shared/booleanFlagCalculator.js`

**Process:**
1. Calls `calculateDataCompletenessScore()` from `shared/dataCompletenessScorer.js`
2. Calculates 0-1 completeness score based on:
   - Basic song info (title, artist, etc.)
   - Sections data (lyrics, timing)
   - Chord progressions (timing, definitions)
   - Timing data quality
3. Calls `calculateContentAvailabilityFlags()` from `shared/booleanFlagCalculator.js`
4. Sets boolean flags:
   - `has_lyric_captions`: true/false
   - `has_chord_captions`: true/false
   - `has_tab_captions`: true/false
5. Calls `calculateTimingAssistanceFlags()` from `shared/booleanFlagCalculator.js`
6. Sets timing assistance flags:
   - `lyrics_need_timing`: true/false
   - `chords_need_timing`: true/false
   - `tabs_need_timing`: true/false
7. Applies admin cascade logic for `needs_user_assistance`

**Output:** `{ data_completeness_score: 0.68, boolean_flags: {...} }`

#### **Step 7: Database Update**
**File:** `url_tab_id_processor.js`  
**Function:** `processUrl()`  
**Dependencies:** `songDatabaseUG.js`

**Process:**
1. Calls `updateExistingSong()` from `songDatabaseUG.js`
2. Updates existing song record with complete data
3. Stores sections in `song_sections` table
4. Stores chord progressions in `song_chord_progressions` table
5. Stores chord definitions in `song_chord_definitions` table
6. Updates boolean flags and completeness score
7. Applies admin cascade logic

**Output:** `{ success: true, songId: "uuid" }`

---

## üìä Data Flow 2: Parent Script DB Query Processing

### **Entry Point:** `parent_script.js`

#### **Step 1: Database Query for Stored Tab IDs**
**File:** `parent_script.js`  
**Function:** `queryStoredTabIds()`  
**Dependencies:** `@supabase/supabase-js`

**Process:**
1. Queries `songs` table for records with `ug_tab_id IS NOT NULL`
2. Filters for songs that need processing
3. Orders by title for consistent processing
4. Returns array of song records

**Output:** `[{ id, title, artist, ug_tab_id }, ...]`

#### **Step 2: Song Processing Loop**
**File:** `parent_script.js`  
**Function:** `processTabIdsBatch()`  
**Dependencies:** `songDatabaseUG.js`

**Process:**
1. Iterates through songs in batches (5 songs per batch)
2. For each song, calls `getSongByUGTabId(ug_tab_id)` from `songDatabaseUG.js`
3. Checks if song already has complete data
4. If complete: skips to next song
5. If incomplete: proceeds to data fetching

**Output:** List of songs needing processing

#### **Step 3: Ultimate Guitar Data Fetching**
**File:** `parent_script.js`  
**Function:** `processTabIdsBatch()`  
**Dependencies:** `songDataServiceUG.js`

**Process:**
1. Calls `getSongDataUG(tabId)` from `songDataServiceUG.js`
2. This internally calls `ugScraperIntegration.js` for Go scraper execution
3. Executes: `ultimate-guitar-scraper export -id 1086983`
4. Receives and parses HTML output
5. Returns structured song data

**Output:** Structured song data object

#### **Step 4: Complete Song Creation**
**File:** `parent_script.js`  
**Function:** `processTabIdsBatch()`  
**Dependencies:** `songDatabaseUG.js`

**Process:**
1. Calls `createCompleteSong(songData)` from `songDatabaseUG.js`
2. This function internally handles:
   - Data completeness scoring (via `shared/dataCompletenessScorer.js`)
   - Boolean flag calculation (via `shared/booleanFlagCalculator.js`)
   - Database storage across multiple tables
3. Creates new complete song record
4. Stores all related data (sections, chord progressions, etc.)

**Output:** `{ success: true, songId: "uuid" }`

---

## üîÑ Shared Processing Modules

### **Core Data Processing Files (Used by Both Flows)**

#### **1. `songDataServiceUG.js`**
**Purpose:** Ultimate Guitar data fetching and transformation  
**Used by:** Both flows  
**Key Functions:**
- `getSongDataUG(tabId)` - Main entry point for UG data fetching
- `transformUGDataToSongFormat(rawData)` - Transforms HTML to structured data
- `extractSongSections(ugData)` - Extracts song sections from UG data
- `extractChordProgressions(ugData)` - Extracts chord progressions from UG data

**Dependencies:**
- `ugScraperIntegration.js` - For Go scraper execution
- `chord_processing/chordExtractor.js` - For chord parsing
- `chord_processing/sectionExtractor.js` - For section parsing

#### **2. `ugScraperIntegration.js`**
**Purpose:** Go scraper execution and output parsing  
**Used by:** Both flows (via `songDataServiceUG.js`)  
**Key Functions:**
- `fetchSongDataUG(tabId)` - Executes Go scraper and parses output
- `parseUGScraperOutput(output)` - Parses HTML output from Go scraper
- `extractRichSongData(htmlContent)` - Extracts structured data from HTML

**Dependencies:**
- Go scraper binary: `ultimate-guitar-scraper`
- `child_process` - For subprocess execution

#### **3. `songDatabaseUG.js`**
**Purpose:** Database operations for song storage and retrieval  
**Used by:** Both flows  
**Key Functions:**
- `createBasicSongRecord(songData)` - Creates minimal song record
- `updateExistingSong(songData)` - Updates existing song with complete data
- `createCompleteSong(songData)` - Creates new complete song record
- `getSongByUGTabId(tabId)` - Retrieves song by UG tab ID
- `getSongWithStructure(songId)` - Retrieves song with all related data

**Dependencies:**
- `@supabase/supabase-js` - Database client
- `shared/dataCompletenessScorer.js` - For scoring calculations
- `shared/booleanFlagCalculator.js` - For boolean flag calculations

### **Shared Scoring and Flag Calculation Files**

#### **4. `shared/dataCompletenessScorer.js`**
**Purpose:** Calculates data completeness scores and main boolean flags  
**Used by:** Both flows (via `songDatabaseUG.js`)  
**Key Functions:**
- `calculateDataCompletenessScore(songData)` - Calculates 0-1 completeness score
- Implements admin cascade logic for `needs_user_assistance`
- Calculates `is_ui_ready` flag

**Scoring Logic:**
- Basic info (title, artist): 0.2 points
- Sections data: 0.3 points
- Chord progressions: 0.3 points
- Timing data: 0.2 points

#### **5. `shared/booleanFlagCalculator.js`**
**Purpose:** Calculates content availability and timing assistance flags  
**Used by:** Both flows (via `songDatabaseUG.js`)  
**Key Functions:**
- `calculateContentAvailabilityFlags(songData)` - Sets has_*_captions flags
- `calculateTimingAssistanceFlags(songData)` - Sets *_need_timing flags

**Flag Logic:**
- `has_lyric_captions`: true if sections contain lyrics
- `has_chord_captions`: true if chord progressions exist
- `has_tab_captions`: true if sections or chord progressions exist
- `*_need_timing`: true if content exists but lacks real timing (not 0:00)

#### **6. `shared/urlParser.js`**
**Purpose:** URL parsing and tab ID extraction  
**Used by:** HTML Tab ID flow only  
**Key Functions:**
- `extractTabIdAndTypeFromUrl(url)` - Extracts tab ID and song type from URL
- `extractTabIdFromUrl(url)` - Extracts just tab ID from URL

**Parsing Logic:**
- Supports multiple URL formats
- Extracts song types: chords, tabs, guitar-pro, bass, ukulele, piano
- Validates tab ID format

---

## üîÑ Flow Convergence Points

### **Convergence Point 1: Ultimate Guitar Data Fetching**
Both flows converge at the UG data fetching step:
- **HTML Flow:** `url_tab_id_processor.js` ‚Üí `ugScraperIntegration.js`
- **Parent Flow:** `parent_script.js` ‚Üí `songDataServiceUG.js` ‚Üí `ugScraperIntegration.js`

**Shared Process:**
1. Execute Go scraper: `ultimate-guitar-scraper export -id {tabId}`
2. Parse HTML output
3. Extract structured song data
4. Return standardized song object

### **Convergence Point 2: Data Scoring and Flag Calculation**
Both flows use identical scoring logic:
- **HTML Flow:** `url_tab_id_processor.js` ‚Üí `shared/dataCompletenessScorer.js`
- **Parent Flow:** `parent_script.js` ‚Üí `songDatabaseUG.js` ‚Üí `shared/dataCompletenessScorer.js`

**Shared Process:**
1. Calculate data completeness score (0-1)
2. Calculate content availability flags
3. Calculate timing assistance flags
4. Apply admin cascade logic for `needs_user_assistance`

### **Convergence Point 3: Database Storage**
Both flows use identical database storage logic:
- **HTML Flow:** `url_tab_id_processor.js` ‚Üí `songDatabaseUG.js`
- **Parent Flow:** `parent_script.js` ‚Üí `songDatabaseUG.js`

**Shared Process:**
1. Store song record in `songs` table
2. Store sections in `song_sections` table
3. Store chord progressions in `song_chord_progressions` table
4. Store chord definitions in `song_chord_definitions` table
5. Update boolean flags and completeness scores

---

## üìã File Dependency Matrix

| File | HTML Flow | Parent Flow | Purpose |
|------|-----------|-------------|---------|
| `url_tab_id_processor.js` | ‚úÖ Entry | ‚ùå | URL processing entry point |
| `parent_script.js` | ‚ùå | ‚úÖ Entry | Database query entry point |
| `shared/urlParser.js` | ‚úÖ | ‚ùå | URL parsing |
| `songDataServiceUG.js` | ‚úÖ | ‚úÖ | UG data fetching & transformation |
| `ugScraperIntegration.js` | ‚úÖ | ‚úÖ | Go scraper execution |
| `songDatabaseUG.js` | ‚úÖ | ‚úÖ | Database operations |
| `shared/dataCompletenessScorer.js` | ‚úÖ | ‚úÖ | Data completeness scoring |
| `shared/booleanFlagCalculator.js` | ‚úÖ | ‚úÖ | Boolean flag calculation |
| `chord_processing/chordExtractor.js` | ‚úÖ | ‚úÖ | Chord data extraction |
| `chord_processing/sectionExtractor.js` | ‚úÖ | ‚úÖ | Section data extraction |

---

## üéØ Key Differences Between Flows

### **HTML Tab ID Flow**
- **Input:** Ultimate Guitar URL
- **Database Operation:** Updates existing basic song record
- **Use Case:** Processing new songs from URLs
- **Unique Steps:** URL parsing, basic record creation

### **Parent Script DB Query Flow**
- **Input:** Database query for stored tab IDs
- **Database Operation:** Creates new complete song record
- **Use Case:** Processing songs already in database
- **Unique Steps:** Database querying, batch processing

---

## üîß Configuration and Environment

### **Required Environment Variables**
Both flows require:
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key

### **Required External Dependencies**
Both flows require:
- Go scraper binary: `ultimate-guitar-scraper`
- Node.js with ES modules support
- Supabase database with enhanced schema

### **Database Schema Requirements**
Both flows require:
- `songs` table with enhanced schema
- `song_sections` table
- `song_chord_progressions` table
- `song_chord_definitions` table
- `song_attributes` table

---

## üöÄ Performance Considerations

### **HTML Tab ID Flow**
- **Processing Speed:** Single song processing
- **Rate Limiting:** Built-in delays between requests
- **Error Handling:** Individual song error handling
- **Memory Usage:** Low (single song at a time)

### **Parent Script DB Query Flow**
- **Processing Speed:** Batch processing (5 songs per batch)
- **Rate Limiting:** Delays between batches and songs
- **Error Handling:** Batch error handling with retry logic
- **Memory Usage:** Moderate (batch of songs in memory)

---

## üîç Testing and Validation

### **Test Files**
- `test_single_song.js` - Tests single song processing (Parent flow logic)
- `test_song_data_service.js` - Tests UG data service
- `test_database_integration.js` - Tests database operations

### **Validation Points**
1. **URL Parsing:** Validates tab ID extraction
2. **Data Fetching:** Validates UG scraper output
3. **Data Transformation:** Validates structured data creation
4. **Scoring:** Validates completeness score calculation
5. **Storage:** Validates database record creation/update

---

## üìù Conclusion

Both data flows are designed to process Ultimate Guitar chord songs efficiently while sharing common processing logic. The HTML Tab ID flow is optimized for processing new songs from URLs, while the Parent Script DB Query flow is optimized for batch processing of songs already stored in the database.

The convergence points ensure consistent data quality and processing standards across both flows, while the modular design allows for easy maintenance and extension of the processing pipeline.

**Key Benefits:**
- Consistent data processing across both flows
- Shared scoring and validation logic
- Modular design for easy maintenance
- Comprehensive error handling
- Scalable batch processing capabilities